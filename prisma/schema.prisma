generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String      @id @default(cuid())
  name         String
  email        String      @unique
  zip          String
  passwordHash String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  preference   Preference?
  briefs       EventBrief[]
  ingestRuns   IngestRun[]
  pollVotes    PollVote[]
}

model Preference {
  id           String   @id @default(cuid())
  userId       String   @unique
  trackedIssues Json
  trackedReps   Json
  homeModules   Json
  justFacts     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EventBrief {
  id                String   @id @default(cuid())
  slug              String   @unique
  event             String
  leftSaying        Json
  rightSaying       Json
  factsSoFar        Json
  whyLeft           String
  whyRight          String
  historicalContext Json
  published         Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  authorId          String
  author            User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model Story {
  id              String   @id @default(cuid())
  title           String
  url             String   @unique
  imageUrl        String?
  source          String
  publishedAt     DateTime
  topic           String
  summary         String
  justFacts       String
  leftPerspective String
  rightPerspective String
  historyAnalysis String?
  historicalComparisons Json?
  factualPoints   Json
  confidence      Int
  biasLabel       String
  rawDescription  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model IngestRun {
  id           String   @id @default(cuid())
  startedAt    DateTime @default(now())
  finishedAt   DateTime?
  status       String
  provider     String
  processed    Int      @default(0)
  created      Int      @default(0)
  skipped      Int      @default(0)
  errorMessage String?
  triggeredBy  String
  actorId      String?
  actor        User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)
}

model Poll {
  id        String       @id @default(cuid())
  slug      String       @unique
  question  String
  active    Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  options   PollOption[]
  votes     PollVote[]
}

model PollOption {
  id        String    @id @default(cuid())
  pollId    String
  label     String
  votes     Int       @default(0)
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  poll      Poll      @relation(fields: [pollId], references: [id], onDelete: Cascade)
  pollVotes PollVote[]
}

model PollVote {
  id        String     @id @default(cuid())
  pollId    String
  optionId  String
  userId    String?
  voterKey  String
  createdAt DateTime   @default(now())
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  user      User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([pollId, voterKey])
}
